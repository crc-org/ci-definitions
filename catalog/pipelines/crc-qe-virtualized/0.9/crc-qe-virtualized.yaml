---
apiVersion: tekton.dev/v1beta1
kind: Pipeline
metadata:
  name: crc-qe-virtualized
  labels:
    app.kubernetes.io/version: "0.9"
    redhat.com/product: openshift-local
    redhat.com/phase: qe
  annotations:
    tekton.dev/pipelines.minVersion: "0.44.x"
    tekton.dev/categories: qe
    tekton.dev/tags: openshift-local, qe, nested virualization
    tekton.dev/displayName: "qe for openshift local"
    tekton.dev/platforms: "linux/amd64"
spec:
  description: >-
    This pipeline will run the testing for openshift local on 
    a specific linux version based on nested virtualization

  workspaces:
  - name: pipelines-data
    # This is required when targets are spin on AWS
  - name: cloud-credentials
    # optional: true
    description: |
      This secret will hold the credentials to the target cloud provider it could match depending on the target:
      
      ## AWS
      ocp secret holding the aws credentials. Secret should be accessible to this task.

      ---
      apiVersion: v1
      kind: Secret
      metadata:
        name: aws-${name}
        labels:
          app.kubernetes.io/component: ${name}
          app.kubernetes.io/part-of: qe-platform
      type: Opaque
      data:
        access-key: ${access_key}
        secret-key: ${secret_key}
        region: ${region}

      ## Azure
      ocp secret holding the azure credentials. Secret should be accessible to this task.

      ---
      apiVersion: v1
      kind: Secret
      metadata:
        name: az-${name}
        labels:
          app.kubernetes.io/component: ${name}
          app.kubernetes.io/part-of: qe-platform
      type: Opaque
      data:
        tenant_id: ${tenant_id}
        subscription_id: ${subscription_id}
        client_id: ${client_id}
        client_secret: ${client_secret}
  - name: rh-account-secret
    optional: true
    description: |
      ocp secret holding the credentials for a valid rh user to subscribe VM. Secret should be accessible to this task.

      ---
      apiVersion: v1
      kind: Secret
      metadata:
        name: credentials-${configname}
      type: Opaque
      data:
        user: ${user}
        password: ${password}
  - name: reportportal-credentials
    description: |
      ocp secret holding the report portal credentials. Secret should be accessible to this task.

      ---
      apiVersion: v1
      kind: Secret
      metadata:
        name: XXX
      type: Opaque
      data:
        token: XXXX
        url: XXXX
        project: XXXX
  - name: ocp-pullsecret
    description: |
      crc secret name holding the pullsecret. This is only required if backed tested is crc preset

      secret should match following format:
      ---
      apiVersion: v1
      kind: Secret
      metadata:
        name: ${secret-name}
      type: Opaque
      data:
        pullsecret: ${pullsecret-value}

  params:
    # Windows related params
    - name: windows-featurepack
      description: windows feature pack (default "22h2-pro")
      # default: 22h2-pro 
      default: "''"
    - name: windows-version
      description: Major version for windows desktop 10 or 11 (default "11")
      # default: '11'
      default: "''"
  
    # Fedora related params
    - name: fedora-version
      description: Fedora Cloud version (i.e 39, 38, 37...)
      default: "''"

    # Rhel related params
    - name: rhel-version
      description: Major.Minor RHEL version (i.e 9.3, 9.2, 9,1...)
      default: "''"
    - name: rhel-arch
      description: architecture for the target machine. Allowed x86_64 or arm64 (default "x86_64")
      default: 'x86_64'
    
    # CRC params
    - name: internal-base-url
      description: in case of an internal release we can not directly download it but upload fisrt to s3. This setup the base url for the assets to be uploaded
      default: "''"
    - name: internal-asset-name
      description: asset name to be uploaded 
      default: "''"
    - name: internal-shasum-name
      description: shasum name to be uploaded 
      default: "''"
    - name: internal-shasum-target-name
      description: setup the name for the internal shasum on s3
      default: "''"
    - name: downloadable-url
      description: full base url to download ditributables and shasumsfiles
      default: ''
    - name: shasum-file
      description: file name for shasum to check distributable
      default: sha256sum.txt

    # QE params
    - name: qe-arch
      description: type of arch (amd64, arm64). Defaults amd64. This should be align with rhel-arch param
      default: amd64
    - name: e2e-tag
      description: tags to select e2e scnearios. Default empty values which means all scnearios  
      default: "''"  
    - name: qe-worspace-subpath
      description: subpath on workspace where storing ephemeral qe results
      default: qe-results
    - name: run-e2e
      description: Control if e2e tests are executed. (true or false)
      default: 'true'
    - name: run-integration
      description: Control if integration tests are executed. (true or false)
      default: 'true'

    # S3 params (Storage results)
    - name: s3-data-secret
      default: datalake-aws
    - name: s3-bucket
      default: crcqe-asia
    - name: s3-folder-path
      description: target folder to store results. (Example release/2.9.0)

    # Pipeline control params
    - name: debug
      description: control verbosity and keep instances after run for troubleshooting. 
      default: 'false'
    - name: target-cleanup
      description: cleanup target ephemeral target folders on each step which requires them
      default: 'true'
    - name: test-catalog
      description: Used for reportportal launch description
      default: 'release-test'
  
  results:
    - name: e2e-results-url
      description: url to access e2e junit results
      value: $(tasks.e2e-url-generator.results.url)
    - name: integration-results-url
      description: url to access e2e junit results
      value: $(tasks.integration-url-generator.results.url)

  tasks:
  - name: correlate
    taskRef:
      name: gather-run-info
    workspaces:
    - name: pipelines-data
      workspace: pipelines-data
  - name: host-info
    runAfter:
    - correlate
    params:
    - name: fedora-version
      value: $(params.fedora-version) 
    - name: rhel-version
      value: $(params.rhel-version) 
    - name: windows-version
      value: $(params.windows-version)$(params.windows-featurepack)
    taskSpec:
      params:
      - name: fedora-version
      - name: rhel-version
      - name: windows-version
      results:
      - name: id
      - name: os
      - name: arch
      steps:
      - image: registry.access.redhat.com/ubi9/ubi-minimal
        script: |
          #!/bin/sh
          arch="amd64"
          os="linux"
          id=""
          if [[ $(params.fedora-version) != "" ]]; then
            id="fedora-x86-$(params.fedora-version)"
          fi
          if [[ $(params.rhel-version) != "" ]]; then
            id="rhel-x86-$(params.rhel-version)"
          fi
          if [[ $(params.windows-version) != "" ]]; then
            os="windows"
            id="windows-x86-$(params.windows-version)"
          fi
          echo -n "${id}" | tee $(results.id.path)
          echo -n "${os}" | tee $(results.os.path)
          echo -n "${arch}" | tee $(results.arch.path)
  - name: s3-info
    runAfter:
    - host-info
    taskRef:
      name: gather-s3-info
    params:
    - name: s3-data-secret
      value: $(params.s3-data-secret) 
    - name: bucket
      value: $(params.s3-bucket) 
    - name: folder-path
      value: $(params.s3-folder-path)/$(tasks.host-info.results.id)
  - name: internal-asset-upload
    when: 
    - input: $(params.internal-base-url)  
      operator: notin
      values: ["''"]
    - input: $(params.internal-asset-name)  
      operator: notin
      values: ["''"]
    runAfter:
    - s3-info
    taskRef:
      name: s3-sync-http
    params:
    - name: asset-url
      value: $(params.internal-base-url)/$(params.internal-asset-name)
    - name: s3-url
      value: $(tasks.s3-info.results.upload-url)
    - name: s3-access-key
      value: $(tasks.s3-info.results.access-key)
    - name: s3-secret-key
      value: $(tasks.s3-info.results.secret-key)
    - name: s3-folder-path
      value: $(tasks.s3-info.results.upload-path)
    - name: s3-asset-name
      value: $(params.internal-asset-name)
    timeout: "15m"
  - name: internal-shasum-upload
    when: 
    - input: $(params.internal-base-url)  
      operator: notin
      values: ["''"]
    - input: $(params.internal-shasum-name)  
      operator: notin
      values: ["''"]
    runAfter:
    - s3-info
    taskRef:
      name: s3-sync-http
    params:
    - name: asset-url
      value: $(params.internal-base-url)/$(params.internal-shasum-name)
    - name: s3-url
      value: $(tasks.s3-info.results.upload-url)
    - name: s3-access-key
      value: $(tasks.s3-info.results.access-key)
    - name: s3-secret-key
      value: $(tasks.s3-info.results.secret-key)
    - name: s3-folder-path
      value: $(tasks.s3-info.results.upload-path)
    - name: s3-asset-name
      value: $(params.internal-shasum-name)
    timeout: "15m"
  - name: url-picker
    runAfter:
      - s3-info
    taskRef:
      name: url-picker
    params:
    - name: internal-base-url
      value: $(params.internal-base-url)
    - name: public-base-url
      value: $(tasks.s3-info.results.download-url)
    - name: external-base-url
      value: $(params.downloadable-url)  
  - name: crc-info
    runAfter:
    - host-info
    taskRef:
      name: gather-crc-info
    params:
    - name:  platform
      value: $(tasks.host-info.results.os)
  - name: provision-fedora
    runAfter:
    - s3-info
    - crc-info
    taskRef:
      resolver: git
      params:
        - name: url
          value: https://github.com/redhat-developer/mapt.git
        - name: revision
          value: v0.8.0
        - name: pathInRepo
          value: tkn/infra-aws-fedora.yaml
    when: 
    - input: $(params.fedora-version)  
      operator: notin
      values: ["''"]
    params:
    - name: secret-aws-credentials
      value: aws-crcqe-bot
    - name: id
      value: $(tasks.correlate.results.correlation)
    - name: operation
      value: create
    - name: host-access-secret-name
      value: host-info-$(tasks.correlate.results.correlation)
    - name: ownerKind
      value: PipelineRun
    - name: ownerName
      value: $(context.pipelineRun.name)
    - name: ownerUid
      value: $(context.pipelineRun.uid)
    - name: nested-virt
      value: 'true'
    - name: version
      value: $(params.fedora-version)  
    - name: tags
      value: "pipelinerunName=$(context.pipelineRun.name)"
    timeout: "20m" 
  - name: provision-rhel
    runAfter:
    - s3-info
    - crc-info
    when: 
    - input: $(params.rhel-version)  
      operator: notin
      values: ["''"]
    taskRef:
      resolver: git
      params:
        - name: url
          value: https://github.com/redhat-developer/mapt.git
        - name: revision
          value: v0.8.0
        - name: pathInRepo
          value: tkn/infra-aws-rhel.yaml
    params:
    - name: secret-aws-credentials
      value: aws-crcqe-bot
    - name: rh-credentials
      value: credentials-rh-subs-crcqe-prod
    - name: id
      value: $(tasks.correlate.results.correlation)
    - name: operation
      value: create
    - name: host-access-secret-name
      value: host-info-$(tasks.correlate.results.correlation)
    - name: ownerKind
      value: PipelineRun
    - name: ownerName
      value: $(context.pipelineRun.name)
    - name: ownerUid
      value: $(context.pipelineRun.uid)
    - name: nested-virt
      value: 'true'
    - name: arch
      value: $(params.rhel-arch)
    - name: version
      value: $(params.rhel-version) 
    - name: tags
      value: "pipelinerunName=$(context.pipelineRun.name)"
    timeout: "20m" 
  - name: provision-windows
    runAfter:
    - s3-info
    - crc-info
    when: 
    - input: $(params.windows-featurepack)  
      operator: notin
      values: ["''"]
    - input: $(params.windows-version)  
      operator: notin
      values: ["''"]
    taskRef:
      resolver: git
      params:
        - name: url
          value: https://github.com/redhat-developer/mapt.git
        - name: revision
          value: v0.8.0
        - name: pathInRepo
          value: tkn/infra-azure-windows-desktop.yaml
    params:
    - name: secret-az-credentials
      value: az-crcqe-bot
    - name: id
      value: $(tasks.correlate.results.correlation)
    - name: operation
      value: create
    - name: host-access-secret-name
      value: host-info-$(tasks.correlate.results.correlation)
    - name: ownerKind
      value: PipelineRun
    - name: ownerName
      value: $(context.pipelineRun.name)
    - name: ownerUid
      value: $(context.pipelineRun.uid)
    - name: nested-virt
      value: 'true'
    - name: windows-featurepack
      value: $(params.windows-featurepack) 
    - name: windows-version
      value: $(params.windows-version) 
    - name: tags
      value: "pipelinerunName=$(context.pipelineRun.name)"
    timeout: "20m" 
  - name: sync-provision
    runAfter:
    - provision-fedora
    - provision-rhel
    - provision-windows
    taskSpec:
      description: This task will get the host info
      params:
        - name: secret-host
        - name: workspace-resources-path
      volumes:
        - name: host-secret
          secret:
            secretName: $(params.secret-host)
        - name: storage
          persistentVolumeClaim:
            claimName: pipelines-data
      results:
        - name: host
        - name: username
        - name: key-filename
      steps:
        - name: sync
          image: quay.io/rhqp/support-tools:v0.0.1
          volumeMounts:
            - name: host-secret
              mountPath: /opt/host-secret
            - name: storage
              mountPath: /opt/storage
          script: |
            #!/bin/sh 

            set -exuo pipefail

            HOST_FILENAME=host
            USERNAME_FILENAME=username
            KEY_FILENAME=id_rsa
            
            workspace_path="/opt/host-secret"

            # Check files
            while [ ! -f "${workspace_path}/${HOST_FILENAME}" ]; do sleep 1; done
            while [ ! -f "${workspace_path}/${USERNAME_FILENAME}" ]; do sleep 1; done
            while [ ! -f "${workspace_path}/${KEY_FILENAME}" ]; do sleep 1; done
            
            # Set results
            cat "${workspace_path}/${HOST_FILENAME}" | tee $(results.host.path)   
            cat "${workspace_path}/${USERNAME_FILENAME}" | tee $(results.username.path)   
            cp "${workspace_path}/${KEY_FILENAME}" /opt/storage/$(params.workspace-resources-path)
            echo -n "${KEY_FILENAME}" | tee $(results.key-filename.path)  
    params:
    - name: secret-host
      value: host-info-$(tasks.correlate.results.correlation)
    - name: workspace-resources-path
      value: $(tasks.correlate.results.correlation)
    timeout: "20m" 
  - name: install
    runAfter:
    - sync-provision
    - internal-asset-upload
    - internal-shasum-upload
    taskRef:
      resolver: bundles 
      params:
      - name: bundle
        value: quay.io/rhqp/crc-support-tkn:v0.5
      - name: name
        value: crc-support
      - name: kind
        value: task
    params:
    - name: os
      value: $(tasks.host-info.results.os)
    - name: host
      value: $(tasks.sync-provision.results.host)
    - name: username
      value: $(tasks.sync-provision.results.username)
    - name: key
      value: $(tasks.sync-provision.results.key-filename)
    - name: workspace-resources-path
      value: $(tasks.correlate.results.workspace-resources-path)
    # Preparing crc version is only used for target path storage  
    - name: downloadable-version
      value: $(tasks.crc-info.results.crc-version)    
    - name: downloadable-url
    # Only accessible url within downloadable-url or internal uploaded composed url  
      value: $(tasks.url-picker.results.base-url)
    - name: shasum-file
      value: $(params.shasum-file)  
    workspaces:
    - name: pipelines-data
      workspace: pipelines-data
    timeout: "1h"  
  - name: qe
    taskRef:
      resolver: bundles 
      params:
      - name: bundle
        value: quay.io/rhqp/crc-e2e-tkn:v1.0.0
      - name: name
        value: crc-e2e
      - name: kind
        value: task
    runAfter:
    - install
    params:
    - name: os
      value: $(tasks.host-info.results.os)
    - name: arch
      value: $(params.qe-arch) 
    - name: host
      value: $(tasks.sync-provision.results.host)
    - name: username
      value: $(tasks.sync-provision.results.username)
    - name: key
      value: $(tasks.sync-provision.results.key-filename)
    - name: workspace-resources-path
      value: $(tasks.correlate.results.workspace-resources-path)
    - name: worspace-qe-subpath
      value: $(params.qe-worspace-subpath) 
    - name: crc-version
      value: $(tasks.crc-info.results.crc-version)
    - name: run-e2e
      value: $(params.run-e2e) 
    - name: e2e-tag
      value: $(params.e2e-tag) 
    - name: e2e-cleanup-target
      value: $(params.target-cleanup) 
    - name: run-integration
      value: $(params.run-integration) 
    - name: integration-cleanup-target
      value: $(params.target-cleanup) 
    - name: debug
      value: $(params.debug) 
    workspaces:
    - name: pipelines-data
      workspace: pipelines-data
    - name: ocp-pullsecret
      workspace: ocp-pullsecret
    timeout: "5h"
  
  - name: datalake-sink
    runAfter:
    - qe
    taskRef:
      name: s3-sink-workspace
    params:
    - name: s3-url
      value: $(tasks.s3-info.results.upload-url)
    - name: s3-access-key
      value: $(tasks.s3-info.results.access-key)
    - name: s3-secret-key
      value: $(tasks.s3-info.results.secret-key)
    - name: s3-folder-path
      value: $(tasks.s3-info.results.upload-path)
    - name: workspace-path
      value: $(tasks.correlate.results.workspace-resources-path)
    - name: workspace-subpath
      value: $(params.qe-worspace-subpath) 
    # Do not delete to keep tf state to decomission on final 
    # This task should be splitted to allow only cleaning up
    - name: workspace-cleanup
      value: 'false'
    workspaces:
    - name: pipelines-data
      workspace: pipelines-data
    timeout: "15m"
  - name: integration-url-generator
    taskRef:
      name: url-generator
    runAfter:
    - datalake-sink
    params:
    - name: base-url
      value: $(tasks.s3-info.results.download-url)
    - name: context
      value: $(params.qe-worspace-subpath)
    - name: asset-name
      value: integration-junit.xml
  - name: e2e-url-generator
    taskRef:
      name: url-generator
    runAfter:
    - datalake-sink
    params:
    - name: base-url
      value: $(tasks.s3-info.results.download-url)
    - name: context
      value: $(params.qe-worspace-subpath)
    - name: asset-name
      value: e2e-junit.xml
  finally:
  - name: debug-info
    when: 
    - input: $(params.rhel-version)  
      operator: notin
      values: ["''"]
    - input: $(params.debug)
      operator: in
      values: ["true"]
    taskSpec:
      workspaces:
      - name: pipelines-data
      params:
      - name: workspace-resources-path
        description: path relative to workspace where to store keys
      steps:
      - name: show-denug-info
        image: registry.access.redhat.com/ubi9/ubi-minimal
        script: |
          #!/bin/sh
          workspace_path=$(workspaces.pipelines-data.path)/$(params.workspace-resources-path)
          echo "private key"
          cat ${workspace_path}/id_rsa
          echo "host"
          cat ${workspace_path}/host
          echo "username"
          cat ${workspace_path}/username
    params:
    - name: workspace-resources-path
      value: $(tasks.correlate.results.workspace-resources-path)
    workspaces:
    - name: pipelines-data
      workspace: pipelines-data
  - name: decomission-fedora
    when: 
    - input: $(params.fedora-version)  
      operator: notin
      values: ["''"]
    taskRef:
      resolver: git
      params:
        - name: url
          value: https://github.com/redhat-developer/mapt.git
        - name: revision
          value: v0.8.0
        - name: pathInRepo
          value: tkn/infra-aws-fedora.yaml
    params:
    - name: secret-aws-credentials
      value: aws-crcqe-bot
    - name: operation
      value: destroy
    - name: id
      value: $(tasks.correlate.results.correlation)
    - name: ownerKind
      value: PipelineRun
    - name: ownerName
      value: $(context.pipelineRun.name)
    - name: ownerUid
      value: $(context.pipelineRun.uid)
    timeout: "40m"  
  - name: decomission-rhel
    when: 
    - input: $(params.rhel-version)  
      operator: notin
      values: ["''"]
    - input: $(params.debug)
      operator: in
      values: ["false"]
    taskRef:
      resolver: git
      params:
        - name: url
          value: https://github.com/redhat-developer/mapt.git
        - name: revision
          value: v0.8.0
        - name: pathInRepo
          value: tkn/infra-aws-rhel.yaml
    params:
    - name: secret-aws-credentials
      value: aws-crcqe-bot
    - name: rh-credentials
      value: credentials-rh-subs-crcqe-prod
    - name: operation
      value: destroy
    - name: id
      value: $(tasks.correlate.results.correlation)
    - name: ownerKind
      value: PipelineRun
    - name: ownerName
      value: $(context.pipelineRun.name)
    - name: ownerUid
      value: $(context.pipelineRun.uid)
    timeout: "40m"  
  - name: decomission-windows
    when: 
    - input: $(params.windows-featurepack)  
      operator: notin
      values: ["''"]
    - input: $(params.windows-version)  
      operator: notin
      values: ["''"]
    taskRef:
      resolver: git
      params:
        - name: url
          value: https://github.com/redhat-developer/mapt.git
        - name: revision
          value: v0.8.0
        - name: pathInRepo
          value: tkn/infra-azure-windows-desktop.yaml
    params:
    - name: secret-az-credentials
      value: az-crcqe-bot
    - name: id
      value: $(tasks.correlate.results.correlation)
    - name: operation
      value: destroy
    - name: ownerKind
      value: PipelineRun
    - name: ownerName
      value: $(context.pipelineRun.name)
    - name: ownerUid
      value: $(context.pipelineRun.uid)
    timeout: "40m"  
  - name: reportportal-import
    taskRef:
      resolver: git
      params:
      - name: url
        value: https://github.com/crc-org/ci-definitions
      - name: revision
        value: main
      - name: pathInRepo
        value: reportportal/tkn/import.yaml
    params:
      - name: results-id
        value: crc-$(tasks.crc-info.results.crc-version)-$(tasks.host-info.results.id)
      - name: results-wsstorage-path
        value: $(tasks.correlate.results.workspace-resources-path)/$(params.qe-worspace-subpath)
      - name: debug
        value: 'true'
      - name: upload-log
        value: 'true'
      - name: launch-attributes
        value: {"attributes": [{"key":"crc-version","value":"$(tasks.crc-info.results.crc-version)"}, {"key": "skippedIssue", "value": true}]}
      - name: launch-description
        value: $(params.test-catalog)
      - name: pipelinerunName
        value: $(context.pipelineRun.name) 
      - name: secret-reportportal
        value: reportportal-crc
      - name: pvc
        value: pipelines-data
    timeout: "15m"  
    
